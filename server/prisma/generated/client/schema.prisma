generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id                 String              @id @default(cuid())
  name               String
  slug               String              @unique
  domain             String?
  type               TenantType          @default(ORGANIZATION)
  settings           Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  isActive           Boolean             @default(true)
  callEvents         CallEvent[]
  callLogs           CallLog[]
  callRecordings     CallRecording[]
  callTranscriptions CallTranscription[]
  contacts           Contact[]
  conversations      Conversation[]
  deals              Deal[]
  integrations       Integration[]
  interactions       Interaction[]
  leads              Lead[]
  pipelines          Pipeline[]
  portalCustomers    PortalCustomer[]
  tickets            Ticket[]
  userInvitations    UserInvitation[]
  users              User[]

  @@index([isActive])
  @@map("tenants")
}

model User {
  id                   String                @id @default(cuid())
  tenantId             String?
  supabaseUserId       String                @unique @map("supabase_user_id")
  email                String                @unique
  firstName            String?               @map("first_name")
  lastName             String?               @map("last_name")
  name                 String?
  role                 UserRole              @default(MEMBER)
  isActive             Boolean               @default(true)
  fcmToken             String?
  pushSubscription     Json?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  avatarUrl            String?
  zammadEmail          String?
  zammadUserId         String?
  conversations        Conversation[]
  interactions         Interaction[]
  telegramLinkRequests TelegramLinkRequest[]
  telegramUsers        TelegramUser[]
  ticketComments       TicketComment[]       @relation("TicketComments")
  ticketsAssigned      Ticket[]              @relation("TicketAssignedUser")
  invitations          UserInvitation[]
  tenant               Tenant?               @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, supabaseUserId])
  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model Contact {
  id              String           @id @default(cuid())
  tenantId        String
  firstName       String
  lastName        String
  email           String?
  phone           String?
  company         String?
  jobTitle        String?
  source          String?
  notes           String?
  customFields    Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  callLogs        CallLog[]
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deals           Deal[]
  interactions    Interaction[]
  leads           Lead[]
  portalCustomers PortalCustomer[]
  tickets         Ticket[]

  @@index([tenantId])
  @@index([email])
  @@map("contacts")
}

model Lead {
  id          String     @id @default(cuid())
  tenantId    String
  contactId   String?
  title       String
  source      String
  status      LeadStatus @default(NEW)
  value       Decimal?
  notes       String?
  convertedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deals       Deal[]
  contact     Contact?   @relation(fields: [contactId], references: [id])
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contactId])
  @@index([status])
  @@map("leads")
}

model Pipeline {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deals       Deal[]
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stages      Stage[]

  @@index([tenantId])
  @@map("pipelines")
}

model Stage {
  id         String   @id @default(cuid())
  pipelineId String
  name       String
  order      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  deals      Deal[]
  pipeline   Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  @@unique([pipelineId, order])
  @@index([pipelineId])
  @@map("stages")
}

model Deal {
  id                String        @id @default(cuid())
  tenantId          String
  contactId         String
  leadId            String?
  pipelineId        String
  stageId           String
  title             String
  description       String?
  value             Decimal?
  probability       Decimal?
  expectedCloseDate DateTime?
  notes             String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  callLogs          CallLog[]
  contact           Contact       @relation(fields: [contactId], references: [id])
  lead              Lead?         @relation(fields: [leadId], references: [id])
  pipeline          Pipeline      @relation(fields: [pipelineId], references: [id])
  stage             Stage         @relation(fields: [stageId], references: [id])
  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  interactions      Interaction[]
  tickets           Ticket[]

  @@index([tenantId])
  @@index([contactId])
  @@index([leadId])
  @@index([pipelineId])
  @@index([stageId])
  @@map("deals")
}

model Interaction {
  id        String          @id @default(cuid())
  tenantId  String
  contactId String
  dealId    String?
  userId    String?
  type      InteractionType
  subject   String?
  content   String
  dateTime  DateTime        @default(now())
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  contact   Contact         @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deal      Deal?           @relation(fields: [dealId], references: [id])
  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User?           @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([contactId])
  @@index([dealId])
  @@index([userId])
  @@index([type])
  @@map("interactions")
}

model Ticket {
  id                        String          @id @default(cuid())
  tenantId                  String
  contactId                 String
  portalCustomerId          String?
  dealId                    String?
  externalId                String?
  externalSystem            String?
  title                     String
  description               String?
  status                    TicketStatus    @default(OPEN)
  priority                  TicketPriority  @default(MEDIUM)
  source                    TicketSource    @default(INTERNAL)
  submittedByPortalCustomer Boolean         @default(false)
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  assignedUserId            String?
  comments                  TicketComment[]
  assignedUser              User?           @relation("TicketAssignedUser", fields: [assignedUserId], references: [id])
  contact                   Contact         @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deal                      Deal?           @relation(fields: [dealId], references: [id])
  portalCustomer            PortalCustomer? @relation(fields: [portalCustomerId], references: [id])
  tenant                    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, externalId, externalSystem])
  @@index([tenantId])
  @@index([contactId])
  @@index([portalCustomerId])
  @@index([dealId])
  @@index([assignedUserId])
  @@index([status])
  @@index([priority])
  @@map("tickets")
}

model TicketComment {
  id               String          @id @default(cuid())
  ticketId         String
  userId           String?
  portalCustomerId String?
  content          String
  authorName       String?
  isInternal       Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  portalCustomer   PortalCustomer? @relation(fields: [portalCustomerId], references: [id], onDelete: Restrict)
  ticket           Ticket          @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user             User?           @relation("TicketComments", fields: [userId], references: [id], onDelete: Restrict)

  @@index([ticketId])
  @@index([userId])
  @@index([portalCustomerId])
  @@map("ticket_comments")
}

model Integration {
  id           String    @id @default(cuid())
  tenantId     String
  serviceName  String
  isActive     Boolean   @default(false)
  config       Json?
  lastSyncAt   DateTime?
  syncStatus   String?
  errorMessage String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, serviceName])
  @@index([tenantId])
  @@map("integrations")
}

model CallLog {
  id               String             @id @default(cuid())
  tenantId         String
  roomName         String
  callerSupabaseId String
  calleeSupabaseId String
  direction        CallDirection      @default(OUTBOUND)
  status           String             @default("INITIATED")
  duration         Int?
  startTime        DateTime           @default(now())
  endTime          DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  contactId        String?
  dealId           String?
  contact          Contact?           @relation(fields: [contactId], references: [id], onDelete: Restrict)
  deal             Deal?              @relation(fields: [dealId], references: [id])
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  recording        CallRecording?
  transcription    CallTranscription?

  @@index([tenantId])
  @@index([callerSupabaseId])
  @@index([calleeSupabaseId])
  @@index([contactId])
  @@index([dealId])
  @@index([roomName])
  @@map("call_logs")
}

model PortalCustomer {
  id               String          @id @default(cuid())
  tenantId         String
  contactId        String?
  supabaseUserId   String?
  email            String
  name             String?
  accessToken      String?         @unique
  fcmToken         String?
  pushSubscription Json?
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  avatarUrl        String?
  zammadEmail      String?
  zammadUserId     String?
  contact          Contact?        @relation(fields: [contactId], references: [id])
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ticketComments   TicketComment[]
  tickets          Ticket[]

  @@unique([tenantId, supabaseUserId])
  @@unique([tenantId, email])
  @@index([supabaseUserId])
  @@index([tenantId])
  @@index([contactId])
  @@index([accessToken])
  @@map("portal_customers")
}

model UserInvitation {
  id            String    @id @default(cuid())
  tenantId      String
  email         String
  role          UserRole  @default(MEMBER)
  invitedBy     String
  token         String    @unique
  expiresAt     DateTime
  acceptedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  invitedByUser User      @relation(fields: [invitedBy], references: [id], onDelete: Cascade)
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([token])
  @@index([expiresAt])
  @@map("user_invitations")
}

model Conversation {
  id        String    @id @default(cuid())
  userId    String
  tenantId  String
  title     String?
  metadata  Json? // Stores entity context: { contacts: {}, leads: {}, deals: {}, lastSearchResults: {} }
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId])
  @@index([tenantId])
  @@index([updatedAt])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  role           String
  content        String
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

model TelegramLinkRequest {
  id        String    @id @default(cuid())
  code      String    @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([userId])
  @@index([expiresAt])
  @@map("telegram_link_requests")
}

model TelegramUser {
  id         String   @id @default(cuid())
  telegramId String   @unique
  userId     String
  username   String?
  firstName  String?
  lastName   String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  avatarUrl  String?
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([telegramId])
  @@index([userId])
  @@map("telegram_users")
}

model CallEvent {
  id        String        @id @default(cuid())
  tenantId  String        @map("tenant_id")
  callerId  String?       @map("caller_id")
  calleeId  String?       @map("callee_id")
  roomName  String        @map("room_name")
  eventType CallEventType @map("event_type")
  payload   Json          @default("{}")
  createdAt DateTime      @default(now()) @map("created_at")
  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([callerId])
  @@index([calleeId])
  @@index([roomName])
  @@index([createdAt])
  @@index([eventType])
  @@index([tenantId, calleeId, createdAt])
  @@map("call_events")
}

model CallRecording {
  id                 String            @id @default(cuid())
  callLogId          String            @unique
  tenantId           String
  fileUrl            String
  fileName           String
  fileSize           Int?
  format             String            @default("webm")
  duration           Int?
  provider           RecordingProvider @default(LIVEKIT)
  providerId         String?
  status             RecordingStatus   @default(REQUESTED)
  recordingStartTime DateTime?
  recordingEndTime   DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  callLog            CallLog           @relation(fields: [callLogId], references: [id], onDelete: Cascade)
  tenant             Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@map("call_recordings")
}

model CallTranscription {
  id         String                @id @default(cuid())
  callLogId  String                @unique
  tenantId   String
  fullText   String
  segments   Json
  language   String                @default("en")
  confidence Float?
  wordCount  Int?
  summary    String?
  keywords   String[]              @default([])
  sentiment  String?
  provider   TranscriptionProvider @default(ASSEMBLYAI)
  providerId String?
  status     TranscriptionStatus   @default(PENDING)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  callLog    CallLog               @relation(fields: [callLogId], references: [id], onDelete: Cascade)
  tenant     Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@map("call_transcriptions")
}

model UserPresence {
  id          String         @id @default(cuid())
  userId      String         @unique
  status      PresenceStatus @default(OFFLINE)
  lastSeen    DateTime       @default(now())
  currentRoom String?
  tenantId    String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([status])
  @@index([tenantId, status])
  @@map("user_presence")
}

model SuperAdmin {
  id             String     @id @default(cuid())
  supabaseUserId String     @unique @map("supabase_user_id")
  email          String     @unique
  firstName      String?    @map("first_name")
  lastName       String?    @map("last_name")
  isActive       Boolean    @default(true)
  lastLoginAt    DateTime?  @map("last_login_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  auditLogs      AuditLog[]

  @@index([email])
  @@index([isActive])
  @@map("super_admins")
}

model AuditLog {
  id           String     @id @default(cuid())
  superAdminId String     @map("super_admin_id")
  action       String
  targetType   String     @map("target_type")
  targetId     String?    @map("target_id")
  metadata     Json?
  ipAddress    String?    @map("ip_address")
  userAgent    String?    @map("user_agent")
  createdAt    DateTime   @default(now()) @map("created_at")
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@index([superAdminId])
  @@index([action])
  @@index([targetType])
  @@index([targetId])
  @@index([createdAt])
  @@map("audit_logs")
}

enum UserRole {
  ADMIN
  MANAGER
  MEMBER
}

enum TenantType {
  ORGANIZATION
  PERSONAL
  BUSINESS
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  UNQUALIFIED
  CONVERTED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketSource {
  INTERNAL
  PORTAL
  EMAIL
  API
}

enum InteractionType {
  EMAIL
  CALL
  MEETING
  NOTE
  TICKET
}

enum CallStatus {
  INITIATED
  RINGING
  CONNECTED
  ENDED
  FAILED
  MISSED
}

enum PresenceStatus {
  ONLINE
  BUSY
  AWAY
  OFFLINE
}

enum RecordingProvider {
  LIVEKIT
  AGORA
  DAILY
  CUSTOM
}

enum RecordingStatus {
  REQUESTED
  IN_PROGRESS
  PROCESSING
  COMPLETED
  FAILED
}

enum TranscriptionProvider {
  DEEPGRAM
  ASSEMBLYAI
  GOOGLE_CLOUD
  LIVEKIT
  AGORA
}

enum TranscriptionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum ParticipantType {
  CRM_USER
  PORTAL_CUSTOMER
}

enum CallEventType {
  CALL_STARTED
  RINGING
  ACCEPTED
  REJECTED
  ENDED
  MISSED
}
